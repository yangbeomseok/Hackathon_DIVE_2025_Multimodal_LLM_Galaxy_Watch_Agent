package com.dive.weatherwatch.ui.viewmodels

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.dive.weatherwatch.data.FishingIndexData
import com.dive.weatherwatch.data.WeatherResponse
import com.dive.weatherwatch.data.DailyTideInfo
import com.dive.weatherwatch.di.NetworkModule
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.launch
import kotlin.math.abs

class FishingIndexViewModel : ViewModel() {
    
    private val fishingIndexService = NetworkModule.fishingIndexService
    
    private val _fishingIndexData = MutableStateFlow<List<FishingIndexData>>(emptyList())
    val fishingIndexData: StateFlow<List<FishingIndexData>> = _fishingIndexData
    
    private val _isLoading = MutableStateFlow(false)
    val isLoading: StateFlow<Boolean> = _isLoading
    
    private val _error = MutableStateFlow<String?>(null)
    val error: StateFlow<String?> = _error
    
    private val _dynamicFishingIndex = MutableStateFlow<Int>(3)
    val dynamicFishingIndex: StateFlow<Int> = _dynamicFishingIndex
    
    private val _algorithmExplanation = MutableStateFlow<String>("")
    val algorithmExplanation: StateFlow<String> = _algorithmExplanation
    
    fun loadFishingIndex(serviceKey: String) {
        viewModelScope.launch {
            try {
                _isLoading.value = true
                _error.value = null
                
                android.util.Log.d("FishingIndexViewModel", "=== ÎÇöÏãú ÏßÄÏàò API Ìò∏Ï∂ú ÏãúÏûë ===")
                android.util.Log.d("FishingIndexViewModel", "üìã API Parameters:")
                android.util.Log.d("FishingIndexViewModel", "  - serviceKey: ${serviceKey.take(20)}...${serviceKey.takeLast(10)}")
                android.util.Log.d("FishingIndexViewModel", "  - numOfRows: 50")
                android.util.Log.d("FishingIndexViewModel", "  - pageNo: 1")
                android.util.Log.d("FishingIndexViewModel", "  - dataType: JSON")
                android.util.Log.d("FishingIndexViewModel", "  - type: json")
                android.util.Log.d("FishingIndexViewModel", "üì° Expected URL: https://apis.data.go.kr/1192136/fcstFishing")
                android.util.Log.d("FishingIndexViewModel", "üîÑ Making API call...")
                
                // ÏÑúÎπÑÏä§ ÌÇ§ Ï≤òÎ¶¨ - Ïó¨Îü¨ Î∞©Ïãù ÏãúÎèÑ
                android.util.Log.d("FishingIndexViewModel", "üîë Service Key Processing:")
                
                // Î∞©Î≤ï 1: ÏõêÎ≥∏ ÌÇ§ Í∑∏ÎåÄÎ°ú
                android.util.Log.d("FishingIndexViewModel", "  - Original key: ${serviceKey.take(20)}...${serviceKey.takeLast(10)}")
                
                // Î∞©Î≤ï 2: URL ÎîîÏΩîÎî©
                val decodedServiceKey = try {
                    java.net.URLDecoder.decode(serviceKey, "UTF-8")
                } catch (e: Exception) {
                    android.util.Log.w("FishingIndexViewModel", "Failed to decode service key, using original")
                    serviceKey
                }
                android.util.Log.d("FishingIndexViewModel", "  - Decoded key: ${decodedServiceKey.take(20)}...${decodedServiceKey.takeLast(10)}")
                
                // Ï≤´ Î≤àÏß∏ ÏãúÎèÑ: ÎîîÏΩîÎî©Îêú ÌÇ§
                android.util.Log.d("FishingIndexViewModel", "üöÄ First attempt with decoded key...")
                var response: com.dive.weatherwatch.data.FishingIndexResponse? = null
                var lastException: Exception? = null
                
                try {
                    response = fishingIndexService.getFishingIndex(
                        serviceKey = decodedServiceKey,
                        numOfRows = 50,
                        pageNo = 1,
                        dataType = "JSON",
                        type = "json"
                    )
                } catch (e: Exception) {
                    android.util.Log.w("FishingIndexViewModel", "First attempt failed: ${e.message}")
                    lastException = e
                    
                    // Îëê Î≤àÏß∏ ÏãúÎèÑ: ÏõêÎ≥∏ ÌÇ§
                    android.util.Log.d("FishingIndexViewModel", "üöÄ Second attempt with original key...")
                    try {
                        response = fishingIndexService.getFishingIndex(
                            serviceKey = serviceKey,
                            numOfRows = 50,
                            pageNo = 1,
                            dataType = "JSON",
                            type = "json"
                        )
                    } catch (e2: Exception) {
                        android.util.Log.w("FishingIndexViewModel", "Second attempt failed: ${e2.message}")
                        lastException = e2
                        
                        // ÏÑ∏ Î≤àÏß∏ ÏãúÎèÑ: type ÌååÎùºÎØ∏ÌÑ∞ Ï†úÍ±∞
                        android.util.Log.d("FishingIndexViewModel", "üöÄ Third attempt without type parameter...")
                        try {
                            response = fishingIndexService.getFishingIndex(
                                serviceKey = decodedServiceKey,
                                numOfRows = 10,
                                pageNo = 1,
                                dataType = "JSON",
                                type = null
                            )
                        } catch (e3: Exception) {
                            android.util.Log.w("FishingIndexViewModel", "Third attempt failed: ${e3.message}")
                            lastException = e3
                            
                            // ÎÑ§ Î≤àÏß∏ ÏãúÎèÑ: ÎåÄÏ≤¥ ÏóîÎìúÌè¨Ïù∏Ìä∏ 1
                            android.util.Log.d("FishingIndexViewModel", "üöÄ Fourth attempt with alternative endpoint 1...")
                            try {
                                response = fishingIndexService.getFishingIndexAlt1(
                                    serviceKey = decodedServiceKey,
                                    numOfRows = 10,
                                    pageNo = 1,
                                    dataType = "JSON"
                                )
                            } catch (e4: Exception) {
                                android.util.Log.w("FishingIndexViewModel", "Fourth attempt failed: ${e4.message}")
                                lastException = e4
                                
                                // Îã§ÏÑØ Î≤àÏß∏ ÏãúÎèÑ: ÎåÄÏ≤¥ ÏóîÎìúÌè¨Ïù∏Ìä∏ 2
                                android.util.Log.d("FishingIndexViewModel", "üöÄ Fifth attempt with alternative endpoint 2...")
                                try {
                                    response = fishingIndexService.getFishingIndexAlt2(
                                        serviceKey = decodedServiceKey,
                                        numOfRows = 10,
                                        pageNo = 1,
                                        dataType = "JSON"
                                    )
                                } catch (e5: Exception) {
                                    android.util.Log.e("FishingIndexViewModel", "All 5 attempts failed, throwing last exception")
                                    throw e5
                                }
                            }
                        }
                    }
                }
                
                if (response == null) {
                    throw lastException ?: Exception("Unknown error occurred")
                }
                
                android.util.Log.d("FishingIndexViewModel", "‚úÖ Raw response received")
                android.util.Log.d("FishingIndexViewModel", "üìÑ Response Structure Analysis:")
                android.util.Log.d("FishingIndexViewModel", "  - response object: ${response}")
                android.util.Log.d("FishingIndexViewModel", "  - response.response: ${response.response}")
                android.util.Log.d("FishingIndexViewModel", "  - header: ${response.response.header}")
                android.util.Log.d("FishingIndexViewModel", "  - header.resultCode: '${response.response.header.resultCode}'")
                android.util.Log.d("FishingIndexViewModel", "  - header.resultMsg: '${response.response.header.resultMsg}'")
                android.util.Log.d("FishingIndexViewModel", "  - body: ${response.response.body}")
                android.util.Log.d("FishingIndexViewModel", "  - body is null: ${response.response.body == null}")
                
                if (response.response.header.resultCode == "00") {
                    android.util.Log.d("FishingIndexViewModel", "üü¢ API Success - parsing data...")
                    android.util.Log.d("FishingIndexViewModel", "  - body.items: ${response.response.body?.items}")
                    android.util.Log.d("FishingIndexViewModel", "  - body.items is null: ${response.response.body?.items == null}")
                    
                    val items = response.response.body?.items?.item ?: emptyList()
                    android.util.Log.d("FishingIndexViewModel", "  - items list: $items")
                    android.util.Log.d("FishingIndexViewModel", "  - items count: ${items.size}")
                    
                    if (items.isNotEmpty()) {
                        val firstItem = items.first()
                        android.util.Log.d("FishingIndexViewModel", "First item details:")
                        android.util.Log.d("FishingIndexViewModel", "  - locationName: ${firstItem.locationName}")
                        android.util.Log.d("FishingIndexViewModel", "  - targetFish: ${firstItem.targetFish}")
                        android.util.Log.d("FishingIndexViewModel", "  - fishingIndex: ${firstItem.fishingIndex}")
                        android.util.Log.d("FishingIndexViewModel", "  - fishingScore: ${firstItem.fishingScore}")
                    }
                    
                    _fishingIndexData.value = items
                    android.util.Log.d("FishingIndexViewModel", "‚úÖ Successfully loaded ${items.size} fishing index items")
                } else if (response.response.header.resultCode == "03") {
                    // NODATA_ERROR - Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞
                    android.util.Log.w("FishingIndexViewModel", "üì≠ No data available from API")
                    android.util.Log.w("FishingIndexViewModel", "  - Result Code: 03 (NODATA_ERROR)")
                    android.util.Log.w("FishingIndexViewModel", "  - Message: ${response.response.header.resultMsg}")
                    
                    // Îπà Î¶¨Ïä§Ìä∏Î°ú ÏÑ§Ï†ïÌïòÍ≥† ÏóêÎü¨Îäî ÏÑ§Ï†ïÌïòÏßÄ ÏïäÏùå
                    _fishingIndexData.value = emptyList()
                    _error.value = null
                    android.util.Log.d("FishingIndexViewModel", "üîß Using test data due to no data available")
                    
                    // ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
                    val testData = listOf(
                        com.dive.weatherwatch.data.FishingIndexData(
                            locationName = "Î∂ÄÏÇ∞ Í¥ëÏïàÎ¶¨",
                            latitude = 35.1536,
                            longitude = 129.1186,
                            predictionDate = "20250822",
                            predictionTime = "Ïò§Ï†Ñ",
                            targetFish = "Í∞êÏÑ±Îèî, ÎÜçÏñ¥, Í¥ëÏñ¥",
                            fishingIndex = 4,
                            fishingScore = 85
                        )
                    )
                    _fishingIndexData.value = testData
                } else {
                    android.util.Log.e("FishingIndexViewModel", "üî¥ API Error - non-success result code")
                    android.util.Log.e("FishingIndexViewModel", "  - Expected: '00'")
                    android.util.Log.e("FishingIndexViewModel", "  - Actual: '${response.response.header.resultCode}'")
                    android.util.Log.e("FishingIndexViewModel", "  - Message: '${response.response.header.resultMsg}'")
                    
                    val errorMsg = "API Error: ${response.response.header.resultCode} - ${response.response.header.resultMsg}"
                    _error.value = errorMsg
                    android.util.Log.e("FishingIndexViewModel", "‚ùå $errorMsg")
                }
                
            } catch (e: Exception) {
                android.util.Log.e("FishingIndexViewModel", "üí• Exception occurred during API call")
                android.util.Log.e("FishingIndexViewModel", "  - Exception type: ${e.javaClass.simpleName}")
                android.util.Log.e("FishingIndexViewModel", "  - Exception message: ${e.message}")
                android.util.Log.e("FishingIndexViewModel", "  - Cause: ${e.cause}")
                android.util.Log.e("FishingIndexViewModel", "  - Stack trace:")
                
                val errorMsg = "Failed to load fishing index: ${e.message}"
                _error.value = errorMsg
                android.util.Log.e("FishingIndexViewModel", "‚ùå Exception: $errorMsg", e)
                e.printStackTrace()
                
                // ÏûÑÏãú ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ (API Ïã§Ìå® Ïãú ÎåÄÏ≤¥Ïö©)
                android.util.Log.d("FishingIndexViewModel", "üîß Using test data as fallback")
                val testData = listOf(
                    com.dive.weatherwatch.data.FishingIndexData(
                        locationName = "Î∂ÄÏÇ∞ Í¥ëÏïàÎ¶¨",
                        latitude = 35.1536,
                        longitude = 129.1186,
                        predictionDate = "20250822",
                        predictionTime = "Ïò§Ï†Ñ",
                        targetFish = "Í∞êÏÑ±Îèî, ÎÜçÏñ¥, Í¥ëÏñ¥",
                        fishingIndex = 4,
                        fishingScore = 85
                    )
                )
                _fishingIndexData.value = testData
                _error.value = null // ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© Ïãú ÏóêÎü¨ ÌÅ¥Î¶¨Ïñ¥
            } finally {
                _isLoading.value = false
                android.util.Log.d("FishingIndexViewModel", "=== ÎÇöÏãú ÏßÄÏàò API Ìò∏Ï∂ú ÏôÑÎ£å ===")
            }
        }
    }
    
    fun clearError() {
        _error.value = null
    }
    
    /**
     * Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú ÎèôÏ†Å ÎÇöÏãú ÏßÄÏàòÎ•º Í≥ÑÏÇ∞Ìï©ÎãàÎã§
     */
    fun calculateDynamicFishingIndex(
        weatherData: WeatherResponse?,
        tideData: List<DailyTideInfo>,
        targetFish: String = "Í∞êÏÑ±Îèî"
    ) {
        viewModelScope.launch {
            try {
                val weatherScore = calculateWeatherScore(weatherData)
                val tideScore = calculateTideScore(tideData)
                val waterTempScore = calculateWaterTempScore(weatherData)
                val waveScore = calculateWaveScore(weatherData)
                val windScore = calculateWindScore(weatherData)
                val cloudScore = calculateCloudScore(weatherData)
                
                // Í∞ÄÏ§ëÏπò Ï†ÅÏö©
                val totalScore = when(targetFish) {
                    "Í∞êÏÑ±Îèî" -> {
                        (weatherScore * 0.25) + (tideScore * 0.25) + 
                        (waterTempScore * 0.30) + (waveScore * 0.10) + 
                        (windScore * 0.05) + (cloudScore * 0.05)
                    }
                    "ÎÜçÏñ¥" -> {
                        (weatherScore * 0.20) + (tideScore * 0.35) + 
                        (waterTempScore * 0.20) + (waveScore * 0.15) + 
                        (windScore * 0.05) + (cloudScore * 0.05)
                    }
                    else -> {
                        (weatherScore * 0.25) + (tideScore * 0.25) + 
                        (waterTempScore * 0.20) + (waveScore * 0.15) + 
                        (windScore * 0.10) + (cloudScore * 0.05)
                    }
                }
                
                val finalIndex = (totalScore.toInt()).coerceIn(1, 5)
                _dynamicFishingIndex.value = finalIndex
                
                // ÏïåÍ≥†Î¶¨Ï¶ò ÏÑ§Î™Ö ÏÉùÏÑ±
                generateAlgorithmExplanation(
                    weatherScore, tideScore, waterTempScore, 
                    waveScore, windScore, cloudScore, 
                    finalIndex, targetFish
                )
                
                android.util.Log.d("FishingIndexVM", 
                    "ÎèôÏ†Å ÎÇöÏãúÏßÄÏàò Í≥ÑÏÇ∞: ÎÇ†Ïî®($weatherScore) + Î¨ºÎïå($tideScore) + ÏàòÏò®($waterTempScore) + ÌååÍ≥†($waveScore) + ÌíçÏÜç($windScore) + Íµ¨Î¶Ñ($cloudScore) = ${finalIndex}Ï†ê"
                )
                
            } catch (e: Exception) {
                android.util.Log.e("FishingIndexVM", "ÎèôÏ†Å ÎÇöÏãúÏßÄÏàò Í≥ÑÏÇ∞ Ïã§Ìå®: ${e.message}")
                _dynamicFishingIndex.value = 3 // Í∏∞Î≥∏Í∞í
            }
        }
    }
    
    private fun calculateWeatherScore(weatherData: WeatherResponse?): Double {
        val currentWeather = weatherData?.response?.body?.items?.item
            ?.filter { it.category == "SKY" }
            ?.firstOrNull()?.fcstValue?.toIntOrNull()
        
        return when(currentWeather) {
            1 -> 5.0  // ÎßëÏùå
            3 -> 4.0  // Íµ¨Î¶ÑÎßéÏùå  
            4 -> 3.0  // ÌùêÎ¶º
            else -> 3.0
        }
    }
    
    private fun calculateTideScore(tideData: List<DailyTideInfo>): Double {
        if (tideData.isEmpty()) return 3.0
        
        val today = tideData.firstOrNull() ?: return 3.0
        
        // Î¨ºÎïå Í∞ïÎèÑ Í≥ÑÏÇ∞ (Ï°∞Ï∞®Í∞Ä ÌÅ¥ÏàòÎ°ù ÎÜíÏùÄ Ï†êÏàò)
        val tideRange = if (today.tideEvents.size >= 2) {
            val maxLevel = today.tideEvents.maxOfOrNull { it.height } ?: 100
            val minLevel = today.tideEvents.minOfOrNull { it.height } ?: 100
            abs(maxLevel - minLevel)
        } else 100
        
        return when {
            tideRange >= 150 -> 5.0  // ÎåÄÏ°∞
            tideRange >= 100 -> 4.0  // Ï§ëÏ°∞
            tideRange >= 50 -> 3.0   // ÏÜåÏ°∞
            else -> 2.0              // Îß§Ïö∞ ÏïΩÌïú Ï°∞Î•ò
        }
    }
    
    private fun calculateWaterTempScore(weatherData: WeatherResponse?): Double {
        // ÌòÑÏû¨ Í∏∞Ïò®ÏùÑ Í∏∞Ï§ÄÏúºÎ°ú ÏàòÏò® Ï∂îÏ†ï (ÏûÑÏãú)
        val currentTemp = weatherData?.response?.body?.items?.item
            ?.filter { it.category == "TMP" }
            ?.firstOrNull()?.fcstValue?.toDoubleOrNull() ?: 20.0
        
        val estimatedWaterTemp = currentTemp - 2.0 // ÏàòÏò®ÏùÄ Î≥¥ÌÜµ Í∏∞Ïò®Î≥¥Îã§ 2ÎèÑ Ï†ïÎèÑ ÎÇÆÏùå
        
        return when {
            estimatedWaterTemp in 18.0..25.0 -> 5.0  // Ï†ÅÏ†ï ÏàòÏò®
            estimatedWaterTemp in 15.0..18.0 || estimatedWaterTemp in 25.0..28.0 -> 3.0
            else -> 1.0
        }
    }
    
    private fun calculateWaveScore(weatherData: WeatherResponse?): Double {
        val windSpeed = weatherData?.response?.body?.items?.item
            ?.filter { it.category == "WSD" }
            ?.firstOrNull()?.fcstValue?.toDoubleOrNull() ?: 5.0
        
        // ÌíçÏÜçÏúºÎ°ú ÌååÍ≥† Ï∂îÏ†ï
        val estimatedWaveHeight = windSpeed * 0.2
        
        return when {
            estimatedWaveHeight < 0.5 -> 5.0
            estimatedWaveHeight < 1.0 -> 3.0
            else -> 1.0
        }
    }
    
    private fun calculateWindScore(weatherData: WeatherResponse?): Double {
        val windSpeed = weatherData?.response?.body?.items?.item
            ?.filter { it.category == "WSD" }
            ?.firstOrNull()?.fcstValue?.toDoubleOrNull() ?: 5.0
        
        return when {
            windSpeed < 3.0 -> 5.0
            windSpeed < 5.0 -> 3.0
            else -> 1.0
        }
    }
    
    private fun calculateCloudScore(weatherData: WeatherResponse?): Double {
        val skyCondition = weatherData?.response?.body?.items?.item
            ?.filter { it.category == "SKY" }
            ?.firstOrNull()?.fcstValue?.toIntOrNull()
        
        return when(skyCondition) {
            1 -> 5.0  // ÎßëÏùå
            3 -> 3.0  // Íµ¨Î¶ÑÎßéÏùå
            4 -> 2.0  // ÌùêÎ¶º
            else -> 3.0
        }
    }
    
    private fun generateAlgorithmExplanation(
        weatherScore: Double,
        tideScore: Double, 
        waterTempScore: Double,
        waveScore: Double,
        windScore: Double,
        cloudScore: Double,
        finalIndex: Int,
        targetFish: String
    ) {
        val explanation = buildString {
            appendLine("üìä ÌòÑÏû¨ Ïã§ÏãúÍ∞Ñ Í≥ÑÏÇ∞ Í≤∞Í≥º")
            appendLine()
            appendLine("üå§Ô∏è ÎÇ†Ïî® Ï°∞Í±¥: ${String.format("%.1f", weatherScore)}Ï†ê (Í∞ÄÏ§ëÏπò 25%)")
            appendLine("üåä Î¨ºÎïå Í∞ïÎèÑ: ${String.format("%.1f", tideScore)}Ï†ê (Í∞ÄÏ§ëÏπò 25%)")
            appendLine("üå°Ô∏è ÏàòÏò® Ï°∞Í±¥: ${String.format("%.1f", waterTempScore)}Ï†ê (Í∞ÄÏ§ëÏπò 20%)")
            appendLine("üí® ÌååÍ≥†/ÌíçÏÜç: ${String.format("%.1f", waveScore)}Ï†ê (Í∞ÄÏ§ëÏπò 15%)")
            appendLine("üí® ÌíçÏÜç Ï°∞Í±¥: ${String.format("%.1f", windScore)}Ï†ê (Í∞ÄÏ§ëÏπò 10%)")
            appendLine("‚òÅÔ∏è Íµ¨Î¶ÑÎüâ: ${String.format("%.1f", cloudScore)}Ï†ê (Í∞ÄÏ§ëÏπò 5%)")
            appendLine()
            appendLine("üßÆ Í≥ÑÏÇ∞ Í≥ºÏ†ï:")
            appendLine("‚Ä¢ (${String.format("%.1f", weatherScore)} √ó 0.25) = ${String.format("%.2f", weatherScore * 0.25)}")
            appendLine("‚Ä¢ (${String.format("%.1f", tideScore)} √ó 0.25) = ${String.format("%.2f", tideScore * 0.25)}")
            appendLine("‚Ä¢ (${String.format("%.1f", waterTempScore)} √ó 0.20) = ${String.format("%.2f", waterTempScore * 0.20)}")
            appendLine("‚Ä¢ (${String.format("%.1f", waveScore)} √ó 0.15) = ${String.format("%.2f", waveScore * 0.15)}")
            appendLine("‚Ä¢ (${String.format("%.1f", windScore)} √ó 0.10) = ${String.format("%.2f", windScore * 0.10)}")
            appendLine("‚Ä¢ (${String.format("%.1f", cloudScore)} √ó 0.05) = ${String.format("%.2f", cloudScore * 0.05)}")
            appendLine()
            val totalScore = (weatherScore * 0.25) + (tideScore * 0.25) + (waterTempScore * 0.20) + 
                           (waveScore * 0.15) + (windScore * 0.10) + (cloudScore * 0.05)
            appendLine("üìä Ï¥ùÌï©: ${String.format("%.2f", totalScore)}Ï†ê")
            appendLine("üéØ ÏµúÏ¢Ö ÏßÄÏàò: ${finalIndex}Ï†ê/5Ï†ê")
            appendLine()
            appendLine("üí° Í∏∞ÏÉÅÏ≤≠ Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ + Ï°∞ÏÑù Ï†ïÎ≥¥ Í∏∞Î∞ò")
        }
        
        _algorithmExplanation.value = explanation
    }
}